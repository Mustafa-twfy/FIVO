# إصلاح مشكلة صلاحيات Supabase (RLS Policies)

## المشكلة
عندما تحاول إرسال إشعارات أو رفع طلبات من الأدمن أو المتجر، تفشل العمليات بسبب عدم وجود سياسات Row Level Security (RLS) مُعدّة بشكل صحيح.

## السبب
- لم يتم تعطيل RLS أو إعداد السياسات المناسبة للجداول
- لم يتم منح الصلاحيات المطلوبة للأدوار (anon, authenticated)

## الحل

### الخطوة 1: فحص الوضع الحالي
1. ادخل إلى Supabase Dashboard
2. اذهب إلى SQL Editor
3. نفذ محتويات الملف `check_permissions.sql`
4. راجع النتائج لمعرفة حالة كل جدول

### الخطوة 2: تطبيق الإصلاح
1. في SQL Editor في Supabase
2. نفذ محتويات الملف `setup_rls_policies.sql`
3. انتظر حتى يكتمل التنفيذ

### الخطوة 3: التحقق من النجاح
1. نفذ `check_permissions.sql` مرة أخرى
2. تأكد من أن جميع الجداول تظهر:
   - RLS_Enabled: false (مُعطّل)
   - أو سياسات مُعرّفة إذا كان RLS مُفعّلًا
3. تأكد من وجود صلاحيات للأدوار anon و authenticated

## الجداول المُعدّلة

### الجداول الرئيسية:
- `orders` - الطلبات
- `notifications` - إشعارات السائقين
- `store_notifications` - إشعارات المتاجر
- `support_messages` - رسائل الدعم للسائقين
- `store_support_messages` - رسائل دعم المتاجر
- `drivers` - السائقين
- `stores` - المتاجر
- `registration_requests` - طلبات التسجيل
- `rewards` - المكافآت
- `fines` - الغرامات
- `app_updates` - تحديثات التطبيق
- `system_settings` - إعدادات النظام

### العمليات المسموحة:
- `SELECT` - القراءة
- `INSERT` - الإدراج
- `UPDATE` - التحديث
- `DELETE` - الحذف

## اختبار النجاح

بعد تطبيق الإصلاح، جرب:

1. **إرسال إشعار من الأدمن:**
   - ادخل كأدمن
   - جرب إرسال إشعار لسائق أو متجر

2. **إنشاء طلب جديد:**
   - ادخل كمتجر
   - جرب إنشاء طلب جديد

3. **قبول/رفض طلب تسجيل:**
   - ادخل كأدمن
   - جرب الموافقة أو رفض طلب تسجيل

## ملاحظات مهمة

### إذا كنت تفضل استخدام RLS مع سياسات:
1. احذف التعليق من القسم الثاني في `setup_rls_policies.sql`
2. نفذ الكود المُعدّل
3. هذا سيفعل RLS مع سياسات تسمح بجميع العمليات

### إذا كنت تريد أمان أكثر:
يمكن تعديل السياسات لتكون أكثر تقييدًا، مثل:
- السائقون يرون إشعاراتهم فقط
- المتاجر ترى طلباتها فقط
- الأدمن يرى كل شيء

### استكشاف الأخطاء:
إذا استمرت المشكلة:
1. تأكد من أن الكود نُفذ بدون أخطاء
2. راجع logs في Supabase
3. تأكد من استخدام المفاتيح الصحيحة (anon key)
4. تحقق من إعدادات Authentication في Supabase

## دعم إضافي

إذا احتجت لمساعدة إضافية:
1. شارك نتائج `check_permissions.sql`
2. شارك أي رسائل خطأ تظهر في الكونسول
3. وضح العملية التي تفشل بالضبط
