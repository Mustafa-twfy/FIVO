# دليل إدارة الأخطاء - نظام توصيل بلس

## نظرة عامة

تم إضافة نظام إدارة أخطاء شامل لجميع العمليات في النظام لسهولة التصحيح وتحديد المشاكل.

## الملفات المحدثة

### 1. LoginScreen.js
- ✅ إدارة أخطاء شاملة في `handleLogin`
- ✅ دالة `testDatabaseConnection` محسنة
- ✅ رسائل تصحيح مفصلة
- ✅ معالجة أخطاء قاعدة البيانات

### 2. RegistrationRequestsScreen.js
- ✅ إدارة أخطاء في `loadRequests`
- ✅ إدارة أخطاء في `approveRequest`
- ✅ إدارة أخطاء في `rejectRequest`
- ✅ رسائل تفصيلية لجميع العمليات

## أنواع الأخطاء المعالجة

### 1. أخطاء قاعدة البيانات
```javascript
// مثال على معالجة خطأ قاعدة البيانات
if (error) {
  console.error('❌ خطأ في قاعدة البيانات:', error);
  console.error('تفاصيل الخطأ:', {
    code: error.code,
    message: error.message,
    details: error.details,
    hint: error.hint
  });
}
```

### 2. أخطاء الاتصال
```javascript
// مثال على معالجة خطأ الاتصال
if (testError) {
  console.error('❌ خطأ في الاتصال بقاعدة البيانات:', testError);
  throw new Error('فشل في الاتصال بقاعدة البيانات: ' + testError.message);
}
```

### 3. أخطاء العمليات
```javascript
// مثال على معالجة خطأ في العملية
if (insertResult?.error) {
  console.error('❌ خطأ في إنشاء الحساب:', insertResult.error);
  throw new Error('فشل في إنشاء الحساب في النظام: ' + insertResult.error.message);
}
```

## رسائل التصحيح

### 1. بداية العملية
```javascript
console.log('=== بداية عملية تسجيل الدخول ===');
console.log('البريد الإلكتروني:', email);
```

### 2. خطوات العملية
```javascript
console.log('=== التحقق من طلبات التسجيل ===');
console.log('نتيجة البحث في طلبات التسجيل:', { pendingRequest, requestError });
```

### 3. نجاح العملية
```javascript
console.log('✅ تم إنشاء الحساب بنجاح');
console.log('=== انتهاء عملية الموافقة بنجاح ===');
```

### 4. فشل العملية
```javascript
console.error('=== خطأ في عملية الموافقة ===');
console.error('نوع الخطأ:', error.constructor.name);
console.error('رسالة الخطأ:', error.message);
console.error('تفاصيل الخطأ:', error);
```

## دالة اختبار قاعدة البيانات

### الميزات
- ✅ اختبار الاتصال بقاعدة البيانات
- ✅ البحث في جميع الجداول
- ✅ عرض تفاصيل الحسابات الموجودة
- ✅ رسائل واضحة للنجاح والفشل

### الاستخدام
```javascript
// الضغط على زر "اختبار قاعدة البيانات" في شاشة تسجيل الدخول
// أو استدعاء الدالة مباشرة
await testDatabaseConnection();
```

### النتائج المتوقعة
```
=== بداية اختبار قاعدة البيانات ===
اختبار الاتصال بقاعدة البيانات...
✅ الاتصال بقاعدة البيانات ناجح
البحث عن الحساب في جدول drivers...
✅ البحث في جدول drivers ناجح
عدد السجلات الموجودة: 2
تفاصيل السائق الأول: { id: 1, email: "test@example.com", ... }
=== انتهاء اختبار قاعدة البيانات ===
```

## خطوات التصحيح

### 1. فتح Console
- **React Native**: استخدم React Native Debugger أو Flipper
- **Web**: فتح Developer Tools (F12) → Console
- **Expo**: استخدم Expo DevTools

### 2. مراقبة الرسائل
```javascript
// ابحث عن هذه الرسائل في Console
=== بداية عملية تسجيل الدخول ===
=== التحقق من طلبات التسجيل ===
=== التحقق من جدول السائقين ===
=== التحقق من جدول المتاجر ===
```

### 3. تحديد المشكلة
```javascript
// إذا رأيت رسائل خطأ مثل:
❌ خطأ في الاتصال بقاعدة البيانات
❌ خطأ في البحث في جدول drivers
❌ خطأ في إنشاء الحساب
```

### 4. تحليل التفاصيل
```javascript
// انظر إلى تفاصيل الخطأ:
{
  code: "PGRST116",        // رمز الخطأ
  message: "No rows found", // رسالة الخطأ
  details: "...",          // تفاصيل إضافية
  hint: "..."              // تلميح لحل المشكلة
}
```

## رموز الأخطاء الشائعة

### PGRST116
- **المعنى**: No rows found
- **السبب**: لم يتم العثور على سجلات
- **الحل**: طبيعي إذا لم يكن هناك حسابات

### PGRST114
- **المعنى**: Multiple rows found
- **السبب**: تم العثور على أكثر من سجل
- **الحل**: استخدم `.single()` بدلاً من `.select()`

### PGRST100
- **المعنى**: Invalid request
- **السبب**: طلب غير صحيح
- **الحل**: تحقق من صحة البيانات المرسلة

## أفضل الممارسات

### 1. استخدام Try-Catch
```javascript
try {
  // العملية
} catch (error) {
  console.error('=== خطأ في العملية ===');
  console.error('نوع الخطأ:', error.constructor.name);
  console.error('رسالة الخطأ:', error.message);
  console.error('تفاصيل الخطأ:', error);
}
```

### 2. فحص الأخطاء
```javascript
if (error && error.code !== 'PGRST116') {
  // معالجة الخطأ فقط إذا لم يكن "No rows found"
}
```

### 3. رسائل واضحة
```javascript
console.log('✅ نجح في العملية');
console.error('❌ فشل في العملية');
```

### 4. تفاصيل كافية
```javascript
console.log('تفاصيل الطلب:', {
  id: request.id,
  email: request.email,
  user_type: request.user_type
});
```

## استكشاف الأخطاء

### مشكلة: لا يتم توجيه المستخدم للواجهة المناسبة

1. **افتح Console**
2. **حاول تسجيل الدخول**
3. **ابحث عن هذه الرسائل**:
   ```
   === بداية عملية تسجيل الدخول ===
   === التحقق من طلبات التسجيل ===
   === التحقق من جدول السائقين ===
   === التحقق من جدول المتاجر ===
   ```

4. **تحقق من النتائج**:
   - هل تم العثور على الحساب؟
   - ما هي حالة الحساب؟
   - هل هناك أخطاء في قاعدة البيانات؟

### مشكلة: فشل في إنشاء الحساب

1. **افتح Console**
2. **حاول الموافقة على طلب**
3. **ابحث عن هذه الرسائل**:
   ```
   === بداية عملية الموافقة على الطلب ===
   إنشاء حساب سائق/متجر...
   نتيجة إنشاء الحساب: ...
   ```

4. **تحقق من الأخطاء**:
   - هل هناك أخطاء في هيكل الجدول؟
   - هل البيانات مكتملة؟
   - هل هناك مشاكل في الاتصال؟

## ملاحظات مهمة

1. **لا تحذف رسائل Console** - فهي ضرورية للتصحيح
2. **استخدم زر اختبار قاعدة البيانات** - لفحص الاتصال
3. **راقب جميع الرسائل** - حتى الرسائل العادية
4. **احفظ سجلات الأخطاء** - للمراجعة لاحقاً
5. **اختبر في بيئة التطوير** - قبل النشر

## الدعم

إذا واجهت مشاكل:
1. راجع رسائل Console
2. تحقق من هذا الدليل
3. راجع ملفات التوثيق الأخرى
4. اختبر قاعدة البيانات
5. تحقق من صحة البيانات 